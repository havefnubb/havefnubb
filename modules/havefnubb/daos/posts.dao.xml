<?xml version="1.0" encoding="UTF-8"?>
<dao xmlns="http://jelix.org/ns/dao/1.0">
    <datasources>
        <primarytable name="posts" realname="posts" primarykey="id_post" />
        <foreigntable name="usr" realname="member" primarykey="id_user" onforeignkey="id_user" />
		<foreigntable name="forum" realname="forum" primarykey="id_forum" onforeignkey="id_forum" />
    </datasources>
    <record>        
		<property name="id_post" 		fieldname="id_post"		datatype="autoincrement"/>
		<property name="id_user" 		fieldname="id_user" 	datatype="int" required="true"/>
		<property name="id_forum" 		fieldname="id_forum" 	datatype="int" required="true"/>
		<property name="parent_id" 		fieldname="parent_id" 	datatype="int" required="true"/>
		<property name="status" 		fieldname="status" 		datatype="string" required="true"/>
		
		<property name="subject" 		fieldname="subject" 	datatype="string" required="true" maxlength="255"/>
		<property name="message" 		fieldname="message" 	datatype="text" required="true"/>
		<property name="date_created" 	fieldname="date_created" datatype="int" required="true"/>
		<property name="date_modified" 	fieldname="date_modified" datatype="int" required="true"/>
		<property name="viewed" 		fieldname="viewed" 		datatype="int" required="true"/> 
		<property name="poster_ip" 		fieldname="poster_ip" 	datatype="string" required="true"/>
		
		<!-- properties from member table -->
		<property name="id" 				fieldname="id_user" datatype="int" table="usr"/>
		<property name="email" 				fieldname="member_email" datatype="string" table="usr" maxlength="255" />
		<property name="login" 				fieldname="member_login" table="usr" required="yes" datatype="string"  maxlength="50" />
		<property name="member_comment" 	fieldname="member_comment" datatype="string" table="usr" maxlength="255"/>
		<property name="member_town" 		fieldname="member_town" datatype="string" table="usr" maxlength="100"/>
		<property name="member_avatar" 		fieldname="member_avatar" datatype="string" table="usr" maxlength="255"/>
		<property name="member_website" 	fieldname="member_website" datatype="string" table="usr" maxlength="255"/>	  
		<property name="nb_msg" 			fieldname="member_nb_msg" table="usr" datatype="integer" />
		<property name="member_last_post" 	fieldname="member_last_post" table="usr"  datatype="integer" />
		
		<!-- properties from forum table -->
		<property name="forum_parent_id" 	fieldname="parent_id" table="forum" datatype="int" required="true"/>
		<property name="forum_name" 		fieldname="forum_name" table="forum" datatype="int" required="true"/>
    </record>	
	
	<!-- naming convention :
		findXXX uses type="select"
		getXXX uses type="selectfirst"
		countXXX uses type="count"		
	-->
    <factory>        
        <!-- get the posts to be displayed on the index of the forum page -->
        <method name="findByIdForum" type="select">
            <parameter name="id_forum" />
            <parameter name="offset" default="0" />
            <parameter name="count" default="200" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="posts.parent_id" />
				<neq property="status" value="pined" />
				<neq property="status" value="pinedclosed" />
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
            <limit offset="$offset" count="$count"/>
        </method>
        <method name="findPinedPostByIdForum" type="select">
            <parameter name="id_forum" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="posts.parent_id" />
				<conditions logic="OR">
					<eq property="status" value="pined" />
					<eq property="status" value="pinedclosed" />
				</conditions>
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>		
        <method name="findAllPinedPost" type="select">
            <conditions>
                <eq property="id_post" expr="posts.parent_id" />
				<conditions logic="OR">
					<eq property="status" value="pined" />
					<eq property="status" value="pinedclosed" />
				</conditions>
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>		
        <method name="findByIdParent" type="select">
            <parameter name="parent_id" />
            <parameter name="offset" default="0" />
            <parameter name="count" default="200" />
            <conditions logic="AND">
                <eq property="parent_id" expr="$parent_id" />
            </conditions>            
            <order>
                <orderitem property="parent_id" way="desc" />
				<orderitem property="id_post" way="asc" />
            </order>
            <limit offset="$offset" count="$count"/>
        </method>    
        <method name="getUserLastCommentOnPosts" type="selectfirst">
            <parameter name="id_post" />
            <conditions>
                <eq property="parent_id" expr="$id_post" />
            </conditions>
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>
        <method name="getUserLastCommentOnForums" type="selectfirst">
            <parameter name="id_forum" />
            <conditions>
                <eq property="id_forum" expr="$id_forum" />
            </conditions>
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>
        <method name="countMessages" type="count">
            <parameter name="id_forum" />
            <conditions>
                <eq property="id_forum" expr="$id_forum" />
            </conditions>            
        </method>
        <method name="countResponse" type="count">
            <parameter name="id_post" />
            <conditions>
                <eq property="parent_id" expr="$id_post" />
            </conditions>           
        </method>
        <method name="countReplies" type="count">
            <parameter name="id_post" />
			<parameter name="parent_id" />
            <conditions>
                <eq property="parent_id" expr="$parent_id" />
				<lteq property="id_post" expr="$id_post" />
            </conditions>
            <order>
                <orderitem property="id_post" way="asc" />
            </order>	
        </method>	
        <method name="getNbOfViewed" type="selectfirst">
            <parameter name="id_post" />
            <conditions>
                <eq property="id_post" expr="$id_post" />
            </conditions>            
        </method>
        <method name="countPostsByForumId" type="count">
            <parameter name="id_forum" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="posts.parent_id" />
            </conditions>            
        </method>    
        <method name="countThreads" type="count">
            <parameter name="id_forum" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="posts.parent_id" />
            </conditions>            
        </method>
        <method name="countMsgsByIdUser" type="count">
            <parameter name="id_user" />
            <conditions>
                <eq property="id_user" expr="$id_user" />
            </conditions>            
        </method>      
       <!-- for stats purpose -->
        <method name="countAllPosts" type="count">
        </method>
        <method name="countAllThreads" type="count">
            <conditions>
                <eq property="id_post" expr="posts.parent_id" />
            </conditions>            
        </method>
        <method name="getLastPost" type="selectfirst">
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>            
        </method>
        <method name="findLastPosts" type="select">
            <parameter name="count" default="5" />
           <conditions>
                <eq property="id_post" expr="posts.parent_id" />
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
            <limit offset="0" count="$count"/>    
        </method>
        <method name="getMyLastEditedPost" type="selectfirst">
            <parameter name="id_user" />
           <conditions>
                <eq property="id_user" expr="$id_user" />
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>
        <method name="findByAuthor" type="select">
			<parameter name="login"/>
            <parameter name="count" default="25" />
           <conditions>
                <eq property="login" expr="$login" />
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
            <limit offset="0" count="$count"/>    
        </method>
        <method name="updateStatusByIdParent" type="update">
			<parameter name="parent_id"/>
			<parameter name="status"/>
           <conditions>
                <eq property="parent_id" expr="$parent_id" />
            </conditions>            
            <values>
				<value property="status" expr="$status" />
			</values>
        </method>
        <method name="moveToForum" type="update">
			<parameter name="id_post"/>
			<parameter name="id_forum"/>
           <conditions>
                <eq property="id_post" expr="$id_post" />
            </conditions>            
            <values>
				<value property="id_forum" expr="$id_forum" />
				<value property="parent_id" expr="$id_post" />
			</values>
        </method>		
    </factory>
</dao>
