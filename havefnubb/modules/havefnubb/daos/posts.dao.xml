<?xml version="1.0" encoding="UTF-8"?>
<dao xmlns="http://jelix.org/ns/dao/1.0">
    <datasources>
        <primarytable name="posts" realname="posts" primarykey="id_post" />
        <foreigntable name="usr" realname="member" primarykey="id_user" onforeignkey="id_user" />        
    </datasources>
    <record>
        
    <property name="id_post" fieldname="id_post" datatype="autoincrement"/>
    <property name="id_user" fieldname="id_user" datatype="int" required="true"/>
    <property name="id_forum" fieldname="id_forum" datatype="int" required="true"/>
    <property name="parent_id" fieldname="parent_id" datatype="int" required="true"/>
    <property name="status" fieldname="status" datatype="int" required="true"/>
    <!--
    1=opened/ouvert
    2=closed/fermé
    3=moved/deplacé
    11=pinned+opened/épinglé+ouvert
    12=closed+opened/épinglé+fermé
    13=moved+opened/épinglé+deplacé
    -->
    <property name="subject" fieldname="subject" datatype="string" required="true" maxlength="255"/>
    <property name="message" fieldname="message" datatype="text" required="true"/>
    <property name="date_created" fieldname="date_created" datatype="datetime" required="true"/>
    <property name="date_modified" fieldname="date_modified" datatype="datetime" required="true"/>
    <property name="viewed" fieldname="viewed" datatype="int" required="true"/> 

    <property name="id" fieldname="id_user" datatype="int" table="usr"/>
    <property name="email" fieldname="member_email" datatype="string" table="usr" maxlength="255" />
	<property name="login" fieldname="member_login" table="usr"
                            required="yes" datatype="string"  maxlength="50" />
    <property name="member_comment" fieldname="member_comment" datatype="string"
                                                    table="usr" maxlength="255"/>
    <property name="member_town" fieldname="member_town" datatype="string" table="usr" maxlength="100"/>
    <property name="member_avatar" fieldname="member_avatar" datatype="string" table="usr" maxlength="255"/>
    <property name="member_website" fieldname="member_website" datatype="string" table="usr" maxlength="255"/>	  
    <property name="nb_msg" fieldname="nb_msg"  table="usr" datatype="integer" />
    </record>
    <factory>        
        <!-- get the posts to be displayed on the index of the forum page -->
        <method name="findByIdForum" type="select">
            <parameter name="id_forum" />
            <parameter name="offset" default="0" />
            <parameter name="count" default="200" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="parent_id" />
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
            <limit offset="$offset" count="$count"/>
        </method>
        <method name="findByIdParent" type="select">
            <parameter name="parent_id" />
            <parameter name="offset" default="0" />
            <parameter name="count" default="200" />
            <conditions logic="AND">
                <eq property="parent_id" expr="$parent_id" />
            </conditions>            
            <order>
                <orderitem property="parent_id" way="desc" />
            </order>
            <limit offset="$offset" count="$count"/>
        </method>    
        <method name="getUserLastCommentOnPosts" type="selectfirst">
            <parameter name="id_post" />
            <conditions>
                <eq property="parent_id" expr="$id_post" />
            </conditions>
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>
        <method name="getUserLastCommentOnForums" type="selectfirst">
            <parameter name="id_forum" />
            <conditions>
                <eq property="id_forum" expr="$id_forum" />
            </conditions>
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
        </method>
        <method name="findNbOfMessages" type="count">
            <parameter name="id_forum" />
            <conditions>
                <eq property="id_forum" expr="$id_forum" />
            </conditions>            
        </method>
        <method name="findNbOfResponse" type="count">
            <parameter name="id_post" />
            <conditions>
                <eq property="parent_id" expr="$id_post" />
            </conditions>           
        </method>
        <method name="findNbOfViewed" type="selectfirst">
            <parameter name="id_post" />
            <conditions>
                <eq property="id_post" expr="$id_post" />
            </conditions>            
        </method>
        <method name="findNbOfPostByForumId" type="count">
            <parameter name="id_forum" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="parent_id" />
            </conditions>            
        </method>    
        <method name="findNbOfThreads" type="count">
            <parameter name="id_forum" />
            <conditions logic="AND">
                <eq property="id_forum" expr="$id_forum" />
                <eq property="id_post" expr="parent_id" />
            </conditions>            
        </method>
        <method name="findIdUserByIdPost" type="selectfirst">
            <parameter name="id_post" />
            <conditions>
                <eq property="id_post" expr="$id_post" />
            </conditions>            
        </method>
        <method name="findNbMsgByIdUser" type="count">
            <parameter name="id_user" />
            <conditions>
                <eq property="id_user" expr="$id_user" />
            </conditions>            
        </method>
        <method name="findForumByIdPost" type="selectfirst">
            <parameter name="id_post" />
            <conditions>
                <eq property="id_post" expr="$id_post" />
            </conditions>            
        </method>
        <method name="findChildByIdPost" type="select">
            <parameter name="id_post" />
            <conditions>
                <eq property="parent_id" expr="$id_post" />
            </conditions>
            <order>
                <orderitem property="id_post" way="asc" />
            </order>            
        </method>        
       <!-- for stats purpose -->
        <method name="countAllPosts" type="count">
        </method>
        <method name="countAllThreads" type="count">
            <conditions>
                <eq property="id_post" expr="parent_id" />
            </conditions>            
        </method>
        <method name="findLastPost" type="selectfirst">
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>            
        </method>
        <method name="getLastPosts" type="select">
            <parameter name="count" default="5" />
           <conditions>
                <eq property="id_post" expr="parent_id" />
            </conditions>            
            <order>
                <orderitem property="date_modified" way="desc" />
            </order>
            <limit offset="0" count="$count"/>    
        </method>        
    </factory>
</dao>
